(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{170:function(e,n,t){e.exports=t(368)},179:function(e,n){},181:function(e,n){},215:function(e,n){},216:function(e,n){},368:function(e,n,t){"use strict";t.r(n);var a=t(44),r=t(0),o=t.n(r),l=t(142),u=t.n(l),c=t(12),i=t.n(c),s=t(24),d=t(13),m=t(63),f=t(370),p=t(372),g=t(371),v=(t(176),function(e){if(!e.show)return null;if(console.log("round",e.round),!e.round)return console.log("no round chosen"),null;if(e.allPointsQuery.loading)return console.log("loading"),o.a.createElement("div",null,"loading...");if(e.allPointsQuery.error)return console.log("error",e.allPointsQuery.error),o.a.createElement("div",null,"error...");console.log("saved state and uploading points state",e.savedState,e.uploadingPoints);var n=e.savedState,t=e.uploadingPoints,a=n||t,r=e.round.users,l=e.trackIndex,u=e.allPointsQuery.data.allPoints,c=e.round,i=r.slice();console.log("all points",u),0===u.length&&(console.log("all points length 0"),e.addNewTrack(),e.changeTrack(0));var s=function(e){var n=-1;return e.forEach(function(e){n<e&&(n=e)}),n}(u.map(function(e){return e.trackIndex}));if(-1===l)return e.changeTrack(s),null;var d=function(n){return function(){e.changeTrack(n),s+1===n&&e.addNewTrack()}},m=function(n,t){return function(){n>-1&&e.updatePoint(n,t.id)}};i.sort(function(e,n){for(var t=function(t){var a=u.filter(function(e){return e.trackIndex===t}),r=a.filter(function(n){return n.user.id===e.id}),o=a.filter(function(e){return e.user.id===n.id});if(0===r.length||0===o.length)return{v:0};var l=r[0].points,c=o[0].points;return l>c?{v:1}:l<c?{v:-1}:void 0},a=l;a>=0;a--){var r=t(a);if("object"===typeof r)return r.v}return 0}),console.log("order",i);var f=[];console.log("max track index",s),0===s&&r.forEach(function(e){});for(var p=0;p<s+1;p++)f.push(o.a.createElement("th",{key:p},p+1));return console.log("track numbers th",f),o.a.createElement("div",{className:"App"},n&&o.a.createElement("div",null,"saved state"),!n&&o.a.createElement("div",null,o.a.createElement("strong",null,"unsaved state")),o.a.createElement("div",null,o.a.createElement("h3",null,c.location.name),o.a.createElement("h3",null,o.a.createElement("div",{className:"row"},o.a.createElement("button",{text:"-",onClick:d(l-1)},"-"),"Track ",l+1,o.a.createElement("button",{text:"+",onClick:d(l+1)},"+"))),o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,"order"),o.a.createElement("th",null,"player"),f,o.a.createElement("th",null,"total"))),o.a.createElement("tbody",null,r.map(function(e){var n=u.filter(function(n){return n.user.id===e.id});if(n){n.sort(function(e,n){return e.trackIndex-n.trackIndex});var t=0===n.length?0:n.map(function(e){return e.points}).reduce(function(e,n){return e+n});return o.a.createElement("tr",{key:e.id},o.a.createElement("td",{key:"order"},function(e){for(var n=0;n<i.length;n++)if(e===i[n])return n+1+".";return"err"}(e)),o.a.createElement("td",{key:e.username},e.username),n.map(function(n){return n.trackIndex===l?o.a.createElement("td",{key:n.trackIndex+e.id},o.a.createElement("strong",null,o.a.createElement("button",{className:"ui button",onClick:m(n.points-1,n.user)},"-"),n.points,o.a.createElement("button",{className:"ui button",onClick:m(n.points+1,n.user)},"+"))):o.a.createElement("td",{key:n.trackIndex+e.id},n.points)}),o.a.createElement("td",null,t))}return o.a.createElement("tr",null,o.a.createElement("td",null,"no plays"))})))),o.a.createElement("br",null),o.a.createElement("div",{className:"row"},o.a.createElement("button",{className:"ui button",text:"delete last track",onClick:function(){e.deleteLastTrack()}},"delete last track"),o.a.createElement("button",{className:"ui button",text:"finish round",onClick:function(){e.finishRound()}},"finnish round"),o.a.createElement("button",{className:"ui button",disabled:a,onClick:function(){e.uploadPoints()}},"upload points")),!1)}),b=function(e){if(!e.show)return null;var n=e.allLocationsQuery.data.allLocations,t=e.allUsersQuery.data.allUsers,a=e.currentLocation,r=e.currentPlayers;return e.allLocationsQuery.loading||e.allUsersQuery.loading?(console.log("loading"),o.a.createElement("div",null,"loading...")):e.allLocationsQuery.error||e.allUsersQuery.error?(console.log("errors",e.allUsersQuery.error,e.allLocationsQuery.error),o.a.createElement("div",null,"error...")):a?o.a.createElement("div",null,o.a.createElement("h3",null,"New round"),o.a.createElement("div",{onClick:e.handleLocationClick(a)},a.name),o.a.createElement("div",null,o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",{key:"header"},o.a.createElement("th",null,"selected players"))),o.a.createElement("tbody",null,o.a.createElement("tr",null,r.map(function(n){return o.a.createElement("td",{className:"ui button",key:n.id,onClick:e.handleUserClick(n)},n.username)}))))),r.length>0&&a&&o.a.createElement("div",null,o.a.createElement("form",{onSubmit:function(n){console.log("start new round with",a,r),n.preventDefault(),e.startNewRound()}},o.a.createElement("button",{className:"ui button",type:"submit"},"start"))),o.a.createElement("div",null,o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,"all players"))),o.a.createElement("tbody",null,t.map(function(n){return o.a.createElement("tr",{key:n.id},o.a.createElement("td",{className:"ui button",onClick:e.handleUserClick(n)},n.username))}))))):o.a.createElement("div",null,o.a.createElement("h3",null,"Select location"),o.a.createElement("div",null,o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",{key:"header"},o.a.createElement("th",null,"locations"))),o.a.createElement("tbody",null,n.map(function(n){return o.a.createElement("tr",{key:n.id},o.a.createElement("td",{className:"ui button",onClick:e.handleLocationClick(n)},n.name))})))))},E=function(e){if(!e.show)return null;if(e.result.loading)return o.a.createElement("div",null,"loading...");if(e.result.error)return console.log("error",e.result.error),o.a.createElement("div",null,"error...");var n=function(n){return function(){console.log("round clicked",n),e.setRound(n)}},t=e.result.data.allRounds;return t.sort(function(e,n){return n.date-e.date}),t?o.a.createElement("div",null,o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",{key:"header"},o.a.createElement("th",null,"location"),o.a.createElement("th",null,"date"),o.a.createElement("th",{colSpan:"99"},"players"))),o.a.createElement("tbody",null,t.map(function(e){var t=new Date(e.date),a=t.getDate()+"."+(t.getMonth()+1)+"."+t.getFullYear()+" "+t.getHours()+":"+t.getMinutes()+":"+t.getSeconds();return o.a.createElement("tr",{onClick:n(e),key:e.id},o.a.createElement("td",null,e.location.name),o.a.createElement("td",null,a),e.users.map(function(e){return o.a.createElement("td",{key:e.username},e.username)}))})))):null},h=function(e){var n=Object(r.useState)(""),t=Object(d.a)(n,2),a=t[0],l=t[1],u=Object(r.useState)(""),c=Object(d.a)(u,2),m=c[0],f=c[1];if(!e.show)return null;var p=function(){var n=Object(s.a)(i.a.mark(function n(t){return i.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:t.preventDefault(),e.doLogin(a,m);case 2:case"end":return n.stop()}},n)}));return function(e){return n.apply(this,arguments)}}();return o.a.createElement("div",{className:"login"},o.a.createElement("h2",null,"Login to application"),o.a.createElement("form",{onSubmit:p,className:"ui form"},o.a.createElement("div",{className:"field"},o.a.createElement("label",null,"Username"),o.a.createElement("input",{id:"username",type:"text",placeholder:"username",value:a,onChange:function(e){l(e.target.value)}})),o.a.createElement("div",{className:"field"},o.a.createElement("label",null,"Password"),o.a.createElement("input",{id:"password",type:"password",placeholder:"password",value:m,onChange:function(e){f(e.target.value)}})),o.a.createElement("button",{className:"ui button",type:"submit"},"login")))},k=t(143),y=t.n(k),I=t(18),w=t(19),j=t.n(w);function O(){var e=Object(I.a)(["\n  mutation addCachedPoints($roundId: ID!, $pointIds: [ID!]!, $userIds: [ID!]!, $trackIndexes:[Int!]!, $points: [Int!]!){\n    addCachedPoints(\n      roundId: $roundId,\n      pointIds: $pointIds,\n      userIds: $userIds,\n      trackIndexes: $trackIndexes,\n      points: $points\n    ){\n      trackIndex,\n      user{id},\n      round{id},\n      points,\n      id\n    }\n  }\n"]);return O=function(){return e},e}function x(){var e=Object(I.a)(["\n  mutation createPlay($roundId: ID!, $playNumber:Int!){\n    addPlay(\n      roundId: $roundId,\n      playNumber: $playNumber\n    ){\n      id\n    }\n  }\n"]);return x=function(){return e},e}function P(){var e=Object(I.a)(["\n  mutation createRound($locationId: ID!, $userIds: [ID!]!){\n    addRound(\n      locationId: $locationId\n      userIds: $userIds\n    ){\n      location{\n        name\n        id\n      }\n      users{\n        username\n        id\n      }\n      date\n      id\n    }\n  }\n"]);return P=function(){return e},e}function N(){var e=Object(I.a)(["\n  mutation createLocation($name: String!){\n    addLocation(\n      name: $name\n    ){\n      id, name\n    }\n  }\n"]);return N=function(){return e},e}function S(){var e=Object(I.a)(["\n{\n  me{\n    username\n    id\n  }\n}\n"]);return S=function(){return e},e}function C(){var e=Object(I.a)(["\nquery {\n  allUsers{\n    username,\n    id\n  }\n}\n"]);return C=function(){return e},e}function Q(){var e=Object(I.a)(["\n  query ($roundId: ID!) {\n    allPoints(\n      roundId: $roundId\n    ){\n    trackIndex,\n    user{id},\n    round{id},\n    points,\n    id\n    }\n  }\n"]);return Q=function(){return e},e}function $(){var e=Object(I.a)(["\n{\n  allRounds {\n    users{username, id}\n    location{name, id}\n    date\n    id\n  }\n}\n"]);return $=function(){return e},e}function L(){var e=Object(I.a)(["\n{\n  allLocations {\n    name\n    id\n  }\n}  \n"]);return L=function(){return e},e}function T(){var e=Object(I.a)(["\n{\n  me {\n    username\n    id\n    friends{username, id}\n  }\n}\n"]);return T=function(){return e},e}function R(){var e=Object(I.a)(["\nmutation login($username: String!, $password: String! ){\n  login(username: $username, password: $password){\n    token\n    username\n  }\n  \n}\n"]);return R=function(){return e},e}var q=j()(R()),D=(j()(T()),j()(L())),U=j()($()),_=j()(Q()),J=j()(C()),M=(j()(S()),j()(N()),j()(P())),B=(j()(x()),j()(O()));var F=function(e){var n,t=function(){console.log("You have been loged out"),e()},a=function(){n=setTimeout(t,36e5)};Object(r.useEffect)(function(){var e=["load","mousedown","click","scroll","keypress"],t=function(){n&&clearTimeout(n),a()};for(var r in e)window.addEventListener(e[r],t);a()},[])},Y=function(e){var n=Object(r.useState)(null),t=Object(d.a)(n,2),l=t[0],u=t[1],c=Object(r.useState)(null),k=Object(d.a)(c,2),I=k[0],w=k[1],j=Object(r.useState)([]),O=Object(d.a)(j,2),x=O[0],P=O[1],N=Object(r.useState)(null),S=Object(d.a)(N,2),C=S[0],Q=S[1],$=Object(r.useState)(null),L=Object(d.a)($,2),T=L[0],R=L[1],Y=Object(r.useState)(0),z=Object(d.a)(Y,2),A=z[0],H=z[1],G=Object(r.useState)(null),K=Object(d.a)(G,2),V=K[0],W=K[1],X=Object(r.useState)(null),Z=Object(d.a)(X,2),ee=Z[0],ne=Z[1],te=Object(r.useState)("main"),ae=Object(d.a)(te,2),re=ae[0],oe=ae[1],le=Object(m.b)(),ue=Object(r.useState)(!0),ce=Object(d.a)(ue,2),ie=ce[0],se=ce[1],de=Object(r.useState)(!1),me=Object(d.a)(de,2),fe=me[0],pe=me[1];Object(r.useEffect)(function(){var e=localStorage.getItem("username"),n=localStorage.getItem("token");console.log("restore logged user",e,n),W(n),ne(e)},[]);var ge=function(){var e=Object(s.a)(i.a.mark(function e(n,t){var a,r,o;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ke({variables:{username:n,password:t}});case 2:a=e.sent,r=a.data.login.token,o=a.data.login.username,console.log("login token and username",r,o),r&&(W(r),ne(n),localStorage.setItem("username",o),localStorage.setItem("token",r),oe("main"),le.resetStore());case 7:case"end":return e.stop()}},e)}));return function(n,t){return e.apply(this,arguments)}}(),ve=function(){console.log("logout"),W(null),ne(null),localStorage.clear(),le.resetStore()};F(ve),e.sessionTimeout&&(console.log("session time out received"),ve());var be=function(e){if(console.log("error",e),e.graphQLErrors.length>0)R(e.graphQLErrors[0].message),setTimeout(function(){R(null)},1e4);else if(e.networkError){var n=e.networkError.result.errors;n&&n.length>0&&(R(n[0].message),setTimeout(function(){R(null)},1e4))}},Ee=Object(f.a)(B,{onError:be,update:function(e,n){var t=n.data.addCachedPoints,a=e.readQuery({query:_,variables:{roundId:l}}).allPoints;se(!0),console.log("local and server lengths",a.length,t.length),t.length!==a.length?se(!1):t.forEach(function(e){var n=!1;a.forEach(function(t){if(e.round.id===t.round.id&&e.user.id===t.user.id&&e.trackIndex===t.trackIndex&&e.points===t.points)return n=!0,void console.log("found match")}),n||(console.log("set saved state to false"),se(!1))}),console.log("local and server points",a,t)}}),he=Object(f.a)(M,{onError:be,update:function(e,n){var t=e.readQuery({query:U}),a=n.data.addRound,r=t.allRounds.filter(function(e){return e.id!==a.id}).concat(a);le.writeQuery({query:U,data:{allRounds:r}})}}),ke=Object(f.a)(q,{onError:be}),ye=function(e,n,t,r){var o=le.readQuery({query:_,variables:{roundId:e}});console.log("original state",o.allPoints);var l=o.allPoints.filter(function(e){return e.user.id===n&&e.trackIndex===t});if(console.log("found data from cache",l.length>0&&l),l.length>0){var u=l[0];console.log("new state",o.allPoints.filter(function(e){return e.id!==u.id}).concat(Object(a.a)({},u,{points:r}))),le.writeQuery({query:_,variables:{roundId:e},data:{allPoints:o.allPoints.filter(function(e){return e.id!==u.id}).concat(Object(a.a)({},u,{points:r}))}})}else{var c={round:{id:e,__typename:"Round"},user:{id:n,__typename:"User"},trackIndex:t,points:r,id:y.a.randomBytes(16).toString("hex"),__typename:"Point"};console.log("add new point",c),le.writeQuery({query:_,variables:{roundId:e},data:{allPoints:o.allPoints.concat(c)}})}se(!1)},Ie=function(e){var n=le.readQuery({query:_,variables:{roundId:e}});if(0!==n.allPoints.length){console.log("original state",n.allPoints);var t=n.allPoints.map(function(e){return e.trackIndex}).sort(function(e,n){return n-e})[0];console.log("maxTrackindex",t),le.writeQuery({query:_,variables:{roundId:e},data:{allPoints:n.allPoints.filter(function(e){return e.trackIndex!==t})}}),se(!1),A>=t&&H(t-1)}},we=function(){var e=Object(s.a)(i.a.mark(function e(){var n,t,a;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==(n=le.readQuery({query:_,variables:{roundId:l}})).allPoints.length){e.next=3;break}return e.abrupt("return");case 3:return t=n.allPoints,console.log("upload points from cache to server",t),e.prev=5,e.next=8,pe(!0);case 8:return e.next=10,Ee({variables:{roundId:l,pointIds:t.map(function(e){return e.id.toString()}),userIds:t.map(function(e){return e.user.id.toString()}),trackIndexes:t.map(function(e){return e.trackIndex}),points:t.map(function(e){return e.points})}});case 10:a=e.sent,pe(!1),console.log("response",a),console.log("server and local state match",ie),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(5),be(e.t0);case 19:case"end":return e.stop()}},e,null,[[5,16]])}));return function(){return e.apply(this,arguments)}}(),je=function(){var e=Object(s.a)(i.a.mark(function e(){var n,t;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(n=I.users,console.log("add new track to round and trackindex",I.id,A,"for users",n),t=0;t<n.length;t++)ye(l,n[t].id,A+1,3);case 3:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}(),Oe=function(){var e=Object(s.a)(i.a.mark(function e(){return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("delete last track"),Ie(l);case 2:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}(),xe=function(){var e=Object(s.a)(i.a.mark(function e(n,t){return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("add point with points and userId",n,"trackIndex",A,t,l),ye(l,t,A,n);case 2:case"end":return e.stop()}},e)}));return function(n,t){return e.apply(this,arguments)}}(),Pe=Object(p.a)(D),Ne=Object(p.a)(J,{skip:!1}),Se=Object(p.a)(_,{skip:!l,variables:{roundId:l}}),Ce=Object(p.a)(U,{skip:!1}),Qe=function(){var e=Object(s.a)(i.a.mark(function e(){var n;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("start new round",C.name,x.map(function(e){return e.username})),e.next=3,he({variables:{userIds:x.map(function(e){return e.id}),locationId:C.id}});case 3:n=e.sent,console.log("response",n),Q(null),P([]),w(n.data.addRound),u(n.data.addRound.id);case 9:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}();return o.a.createElement(g.a,null,V&&o.a.createElement("div",{className:"ui secondary menu"},o.a.createElement("div",{className:"item",onClick:function(){oe("main"),console.log("main")}},"main"),l?o.a.createElement("div",{className:"item",onClick:function(){oe("round"),console.log("continue round")}},"continue round"):o.a.createElement("div",{className:"item",onClick:function(){oe("round"),console.log("new round")}},"new round"),o.a.createElement("div",{className:"item"},ee," logged in"),o.a.createElement("div",{className:"item",onClick:function(){oe(null),ve()}},"logout")),T&&o.a.createElement("div",null,"errorMessage"),!V&&o.a.createElement(h,{doLogin:ge,show:!0,handleError:be}),V&&!l&&o.a.createElement(b,{allLocationsQuery:Pe,allUsersQuery:Ne,handleLocationClick:function(e){return function(){console.log("location clicked",e),Q(e===C?null:e)}},handleUserClick:function(e){return function(){console.log("user clicked",e),x.includes(e)?P(x.filter(function(n){return n!==e})):P(x.concat(e))}},currentLocation:C,currentPlayers:x,startNewRound:Qe,show:"round"===re}),V&&o.a.createElement(E,{result:Ce,setRound:function(e){console.log("round",e),w(e),u(e.id),H(-1)},show:"main"===re}),V&&l&&o.a.createElement(v,{allPointsQuery:Se,round:I,addNewTrack:je,updatePoint:xe,deleteLastTrack:Oe,changeTrack:function(e){H(e)},trackIndex:A,finishRound:function(){console.log("finish round"),w(null),u(null),P([]),Q(null),oe("main")},uploadPoints:we,show:"round"===re,savedState:ie,uploadingPoints:fe}),o.a.createElement("div",null,o.a.createElement("br",null),o.a.createElement("em",null,"Frisbeegolf app, Juho Taipale 2019")))},z=t(154),A=t(27),H=t(156),G=t(155),K=t(153),V=t(11),W=t(152),X=t(2),Z=window.location.origin.replace(/^http/,"ws"),ee="".concat(Z,"/graphql");console.log("websocket uri",ee),console.log("http uri","/graphql");var ne=new W.a({uri:ee,options:{reconnect:!0}}),te=Object(H.a)({uri:"/graphql"}),ae=Object(K.a)(function(e,n){var t=n.headers,r=localStorage.getItem("token");return{headers:Object(a.a)({},t,{authorization:r?"bearer ".concat(r):null})}}),re=Object(V.d)(function(e){var n=e.query,t=Object(X.l)(n),a=t.kind,r=t.operation;return"OperationDefinition"===a&&"subscription"===r},ne,ae.concat(te)),oe=new A.a({link:re,cache:new G.a});u.a.render(o.a.createElement(z.a,{client:oe},o.a.createElement(m.a,{client:oe},o.a.createElement(Y,null))),document.getElementById("root"))}},[[170,1,2]]]);
//# sourceMappingURL=main.1fa5278c.chunk.js.map
(this.webpackJsonpfrontend=this.webpackJsonpfrontend||[]).push([[0],{173:function(e,n,t){e.exports=t(364)},181:function(e,n){},183:function(e,n){},216:function(e,n){},217:function(e,n){},364:function(e,n,t){"use strict";t.r(n);var a=t(49),r=t(1),o=t.n(r),l=t(149),u=t.n(l),c=t(18),i=t.n(c),s=t(16),d=t(24),m=t(369),f=function(e){if(!e.show)return null;if(e.meQuery.loading)return o.a.createElement("div",null,"loading...");if(e.meQuery.error)return console.log("error",e.meQuery.error),o.a.createElement("div",null,"error...");var n=function(n){e.setPage(n)},t=e.meQuery.data.me,a=e.currentRoundId;return o.a.createElement("div",{className:"ui secondary menu"},o.a.createElement("div",{className:"item",onClick:function(){n("main"),console.log("main")}},"main"),a?o.a.createElement("div",{className:"item",onClick:function(){n("round"),console.log("continue round")}},"continue round"):o.a.createElement("div",{className:"item",onClick:function(){n("round"),console.log("new round")}},"new round"),o.a.createElement("div",{className:"item"},t.username," ",t.admin?"(admin) ":"","logged in"),o.a.createElement("div",{className:"item",onClick:function(){n(null),e.doLogout()}},"logout"))},g=function(e){if(!e.show)return null;if(!e.round)return console.log("no round chosen"),null;if(e.allPointsQuery.loading)return console.log("loading"),o.a.createElement("div",null,"loading...");if(e.allPointsQuery.error)return console.log("error",e.allPointsQuery.error),o.a.createElement("div",null,"error...");var n=e.savedState,t=e.uploadingPoints,a=n||t,r=e.round.users,l=e.trackIndex,u=e.allPointsQuery.data.allPoints,c=e.round,i=r.slice();console.log("all points",u);var s=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,t=n;return e.forEach((function(e){t<e&&(t=e)})),t}(u.map((function(e){return e.trackIndex})),-1);if(-1===l&&s>-1)return e.changeTrack(s),null;0===u.length&&(console.log("new round",e.round),e.addNewTrack(),e.changeTrack(0));var d=function(n){return function(){console.log("new index",n,"max index",s),s+1===n&&(console.log("add new track"),e.addNewTrack()),e.changeTrack(n)}},m=function(n,t){return function(){n>-1&&e.updatePoint(n,t.id)}};i.sort((function(e,n){for(var t=function(t){var a=u.filter((function(e){return e.trackIndex===t})),r=a.filter((function(n){return n.user.id===e.id})),o=a.filter((function(e){return e.user.id===n.id}));if(0===r.length||0===o.length)return{v:0};var l=r[0].points,c=o[0].points;return l>c?{v:1}:l<c?{v:-1}:void 0},a=l;a>=0;a--){var r=t(a);if("object"===typeof r)return r.v}return 0}));var f=[];console.log("max track index",s,"track index",l);for(var g=0;g<s+1;g++)f.push(o.a.createElement("th",{key:g},g+1));return console.log("track numbers th",f,"all points",u),o.a.createElement("div",{className:"App"},n&&o.a.createElement("div",null,"saved state"),!n&&o.a.createElement("div",null,o.a.createElement("strong",null,"unsaved state")),o.a.createElement("div",null,o.a.createElement("h3",null,c.location.name),o.a.createElement("h3",null,o.a.createElement("div",{className:"row"},o.a.createElement("button",{text:"-",onClick:d(l-1)},"-"),"Track ",l+1,o.a.createElement("button",{text:"+",onClick:d(l+1)},"+"))),o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,"order"),o.a.createElement("th",null,"player"),f,o.a.createElement("th",null,"total"))),o.a.createElement("tbody",null,r.map((function(e){var n=u.filter((function(n){return n.user.id===e.id}));if(n){n.sort((function(e,n){return e.trackIndex-n.trackIndex}));var t=0===n.length?0:n.map((function(e){return e.points})).reduce((function(e,n){return e+n}));return o.a.createElement("tr",{key:e.id},o.a.createElement("td",{key:"order"},function(e){for(var n=0;n<i.length;n++)if(e===i[n])return n+1+".";return"err"}(e)),o.a.createElement("td",{key:e.username},e.username),n.map((function(n){return n.trackIndex===l?o.a.createElement("td",{key:n.trackIndex+e.id},o.a.createElement("strong",null,o.a.createElement("button",{className:"ui button",onClick:m(n.points-1,n.user)},"-"),n.points,o.a.createElement("button",{className:"ui button",onClick:m(n.points+1,n.user)},"+"))):o.a.createElement("td",{key:n.trackIndex+e.id},n.points)})),o.a.createElement("td",null,t))}return o.a.createElement("tr",null,o.a.createElement("td",null,"no plays"))}))))),o.a.createElement("br",null),o.a.createElement("div",{className:"row"},o.a.createElement("button",{className:"ui button",text:"delete last track",onClick:function(){e.deleteLastTrack()}},"delete last track"),o.a.createElement("button",{className:"ui button",text:"finish round",onClick:function(){e.finishRound()}},"finnish round"),o.a.createElement("button",{className:"ui button",disabled:a,onClick:function(){e.uploadPoints()}},"upload points")),!1)},p=function(e){if(!e.show)return null;var n=e.allLocationsQuery.data.allLocations,t=e.allUsersQuery.data.allUsers,a=e.currentLocation,r=e.currentPlayers;return e.allLocationsQuery.loading||e.allUsersQuery.loading?(console.log("loading"),o.a.createElement("div",null,"loading...")):e.allLocationsQuery.error||e.allUsersQuery.error?(console.log("errors",e.allUsersQuery.error,e.allLocationsQuery.error),o.a.createElement("div",null,"error...")):a?o.a.createElement("div",null,o.a.createElement("h3",null,"New round"),o.a.createElement("div",{onClick:e.handleLocationClick(a)},a.name),o.a.createElement("div",null,o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",{key:"header"},o.a.createElement("th",null,"selected players"))),o.a.createElement("tbody",null,o.a.createElement("tr",null,r.map((function(n){return o.a.createElement("td",{className:"ui button",key:n.id,onClick:e.handleUserClick(n)},n.username)})))))),r.length>0&&a&&o.a.createElement("div",null,o.a.createElement("form",{onSubmit:function(n){console.log("start new round with",a,r),n.preventDefault(),e.startNewRound()}},o.a.createElement("button",{className:"ui button",type:"submit"},"start"))),o.a.createElement("div",null,o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,"all players"))),o.a.createElement("tbody",null,t.map((function(n){return o.a.createElement("tr",{key:n.id},o.a.createElement("td",{className:"ui button",onClick:e.handleUserClick(n)},n.username))})))))):o.a.createElement("div",null,o.a.createElement("h3",null,"Select location"),o.a.createElement("div",null,o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",{key:"header"},o.a.createElement("th",null,"locations"))),o.a.createElement("tbody",null,n.map((function(n){return o.a.createElement("tr",{key:n.id},o.a.createElement("td",{className:"ui button",onClick:e.handleLocationClick(n)},n.name))}))))))},v=function(e){if(!e.show)return null;if(e.result.loading)return o.a.createElement("div",null,"loading...");if(e.result.error)return console.log("error",e.result.error),o.a.createElement("div",null,"error...");var n=function(n){return function(){console.log("round clicked",n),e.setRound(n)}},t=function(n){return function(){console.log("delete round clicked",n),e.deleteRound(n)}},a=e.result.data.allRounds;return a.sort((function(e,n){return n.date-e.date})),a?o.a.createElement("div",null,o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",{key:"header"},o.a.createElement("th",null,"location"),o.a.createElement("th",null,"date"),o.a.createElement("th",{colSpan:"99"},"players"))),o.a.createElement("tbody",null,a.map((function(e){var a=new Date(e.date),r=a.getDate()+"."+(a.getMonth()+1)+"."+a.getFullYear()+" "+a.getHours()+":"+a.getMinutes()+":"+a.getSeconds();return o.a.createElement("tr",{key:e.id},o.a.createElement("td",{onClick:n(e)},e.location.name),o.a.createElement("td",null,r),e.users.map((function(e){return o.a.createElement("td",{key:e.username},e.username)})),o.a.createElement("td",null,o.a.createElement("button",{onClick:t(e)},"delete")))}))))):null},E=function(e){var n=Object(r.useState)(""),t=Object(s.a)(n,2),a=t[0],l=t[1],u=Object(r.useState)(""),c=Object(s.a)(u,2),d=c[0],m=c[1];if(!e.show)return null;return o.a.createElement("div",{className:"login"},o.a.createElement("h2",null,"Login to application"),o.a.createElement("form",{onSubmit:function(n){return i.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:n.preventDefault(),e.doLogin(a,d);case 2:case"end":return t.stop()}}))},className:"ui form"},o.a.createElement("div",{className:"field"},o.a.createElement("label",null,"Username"),o.a.createElement("input",{id:"username",type:"text",placeholder:"username",value:a,onChange:function(e){l(e.target.value)}})),o.a.createElement("div",{className:"field"},o.a.createElement("label",null,"Password"),o.a.createElement("input",{id:"password",type:"password",placeholder:"password",value:d,onChange:function(e){m(e.target.value)}})),o.a.createElement("button",{className:"ui button",type:"submit"},"login")))},b=t(150),h=t.n(b),k=t(19),y=t(20),I=t.n(y);function w(){var e=Object(k.a)(["\n  mutation addCachedPoints($roundId: ID!, $pointIds: [ID!]!, $userIds: [ID!]!, $trackIndexes:[Int!]!, $points: [Int!]!){\n    addCachedPoints(\n      roundId: $roundId,\n      pointIds: $pointIds,\n      userIds: $userIds,\n      trackIndexes: $trackIndexes,\n      points: $points\n    ){\n      trackIndex,\n      user{id},\n      round{id},\n      points,\n      id\n    }\n  }\n"]);return w=function(){return e},e}function j(){var e=Object(k.a)(["\n  mutation createPlay($roundId: ID!, $playNumber:Int!){\n    addPlay(\n      roundId: $roundId,\n      playNumber: $playNumber\n    ){\n      id\n    }\n  }\n"]);return j=function(){return e},e}function O(){var e=Object(k.a)(["\n  mutation removeRound($roundId: ID!){\n    deleteRound(\n      roundId: $roundId\n    ){\n      id\n    }\n  }\n"]);return O=function(){return e},e}function x(){var e=Object(k.a)(["\n  mutation createRound($locationId: ID!, $userIds: [ID!]!){\n    addRound(\n      locationId: $locationId\n      userIds: $userIds\n    ){\n      location{\n        name\n        id\n      }\n      users{\n        username\n        id\n      }\n      date\n      id\n    }\n  }\n"]);return x=function(){return e},e}function P(){var e=Object(k.a)(["\n  mutation createLocation($name: String!){\n    addLocation(\n      name: $name\n    ){\n      id, name\n    }\n  }\n"]);return P=function(){return e},e}function N(){var e=Object(k.a)(["\nquery{\n  me{\n    admin\n    username\n    id\n  }\n}\n"]);return N=function(){return e},e}function Q(){var e=Object(k.a)(["\nquery {\n  allUsers{\n    username,\n    id\n  }\n}\n"]);return Q=function(){return e},e}function S(){var e=Object(k.a)(["\n  query ($roundId: ID!) {\n    allPoints(\n      roundId: $roundId\n    ){\n    trackIndex,\n    user{id},\n    round{id},\n    points,\n    id\n    }\n  }\n"]);return S=function(){return e},e}function C(){var e=Object(k.a)(["\n{\n  allRounds {\n    users{username, id}\n    location{name, id}\n    date\n    id\n  }\n}\n"]);return C=function(){return e},e}function $(){var e=Object(k.a)(["\n{\n  allLocations {\n    name\n    id\n  }\n}  \n"]);return $=function(){return e},e}function R(){var e=Object(k.a)(["\n{\n  me {\n    username\n    id\n    friends{username, id}\n  }\n}\n"]);return R=function(){return e},e}function L(){var e=Object(k.a)(["\nmutation login($username: String!, $password: String! ){\n  login(username: $username, password: $password){\n    token\n    username\n  }\n  \n}\n"]);return L=function(){return e},e}var q=I()(L()),T=(I()(R()),I()($())),D=I()(C()),U=I()(S()),_=I()(Q()),F=I()(N()),J=(I()(P()),I()(x())),M=I()(O()),B=(I()(j()),I()(w()));var Y=function(e){var n,t=function(){console.log("You have been loged out"),e()},a=function(){n=setTimeout(t,36e5)};Object(r.useEffect)((function(){var e=["load","mousedown","click","scroll","keypress"],t=function(){n&&clearTimeout(n),a()};for(var r in e)window.addEventListener(e[r],t);a()}),[])},z=function(e){var n=Object(r.useState)(null),t=Object(s.a)(n,2),l=t[0],u=t[1],c=Object(r.useState)(null),b=Object(s.a)(c,2),k=b[0],y=b[1],I=Object(r.useState)([]),w=Object(s.a)(I,2),j=w[0],O=w[1],x=Object(r.useState)(null),P=Object(s.a)(x,2),N=P[0],Q=P[1],S=Object(r.useState)(null),C=Object(s.a)(S,2),$=C[0],R=C[1],L=Object(r.useState)(0),z=Object(s.a)(L,2),A=z[0],H=z[1],G=Object(r.useState)(null),K=Object(s.a)(G,2),V=K[0],W=K[1],X=Object(r.useState)(null),Z=Object(s.a)(X,2),ee=(Z[0],Z[1]),ne=Object(r.useState)("main"),te=Object(s.a)(ne,2),ae=te[0],re=te[1],oe=Object(d.a)(),le=Object(r.useState)(!0),ue=Object(s.a)(le,2),ce=ue[0],ie=ue[1],se=Object(r.useState)(!1),de=Object(s.a)(se,2),me=de[0],fe=de[1];Object(r.useEffect)((function(){var e=localStorage.getItem("username"),n=localStorage.getItem("token");console.log("restore logged user",e,n),W(n),ee(e)}),[]);var ge=function(){console.log("logout"),W(null),ee(null),localStorage.clear(),oe.resetStore()};Y(ge),e.sessionTimeout&&(console.log("session time out received"),ge());var pe=function(e){if(console.log("error",e),e.graphQLErrors.length>0)R(e.graphQLErrors[0].message),setTimeout((function(){R(null)}),1e4);else if(e.networkError){var n=e.networkError.result.errors;n&&n.length>0&&(R(n[0].message),setTimeout((function(){R(null)}),1e4))}},ve=Object(d.b)(B,{onError:pe,update:function(e,n){var t=n.data.addCachedPoints,a=e.readQuery({query:U,variables:{roundId:l}}).allPoints;ie(!0),console.log("local and server lengths",a.length,t.length),t.length!==a.length?ie(!1):t.forEach((function(e){var n=!1;a.forEach((function(t){if(e.round.id===t.round.id&&e.user.id===t.user.id&&e.trackIndex===t.trackIndex&&e.points===t.points)return n=!0,void console.log("found match")})),n||(console.log("set saved state to false"),ie(!1))})),console.log("local and server points",a,t)}}),Ee=Object(d.b)(J,{onError:pe,update:function(e,n){var t=e.readQuery({query:D}),a=n.data.addRound,r=t.allRounds.filter((function(e){return e.id!==a.id})).concat(a);oe.writeQuery({query:D,data:{allRounds:r}})}}),be=Object(d.b)(M,{onError:pe,update:function(e,n){var t=e.readQuery({query:D}),a=n.data.deleteRound;console.log("deleted round",a,"rounds before",t.allRounds);var r=t.allRounds.filter((function(e){return e.id!==a.id}));console.log("new data in store",r),oe.writeQuery({query:D,data:{allRounds:r}})}}),he=Object(d.b)(q,{onError:pe}),ke=function(e,n,t,r){console.log("add point with roundId userId, trackindex, points",e,n,t,r);var o=oe.readQuery({query:U,variables:{roundId:e}});console.log("original state",o.allPoints);var l=o.allPoints.filter((function(e){return e.user.id===n&&e.trackIndex===t}));if(console.log("found data from cache",l.length>0&&l),l.length>0){var u=l[0];console.log("new state",o.allPoints.filter((function(e){return e.id!==u.id})).concat(Object(a.a)({},u,{points:r}))),oe.writeQuery({query:U,variables:{roundId:e},data:{allPoints:o.allPoints.filter((function(e){return e.id!==u.id})).concat(Object(a.a)({},u,{points:r}))}})}else{var c={round:{id:e,__typename:"Round"},user:{id:n,__typename:"User"},trackIndex:t,points:r,id:h.a.randomBytes(16).toString("hex"),__typename:"Point"};console.log("add new point",c),oe.writeQuery({query:U,variables:{roundId:e},data:{allPoints:o.allPoints.concat(c)}})}ie(!1)},ye=function(e){var n=oe.readQuery({query:U,variables:{roundId:e}});if(0!==n.allPoints.length){console.log("original state",n.allPoints);var t=n.allPoints.map((function(e){return e.trackIndex})).sort((function(e,n){return n-e}))[0];console.log("maxTrackindex",t),oe.writeQuery({query:U,variables:{roundId:e},data:{allPoints:n.allPoints.filter((function(e){return e.trackIndex!==t}))}}),ie(!1),A>=t&&H(t-1)}},Ie=Object(d.c)(T),we=Object(d.c)(_,{skip:!1}),je=Object(d.c)(U,{skip:!l,variables:{roundId:l}}),Oe=Object(d.c)(D,{skip:!1}),xe=Object(d.c)(F);return o.a.createElement(m.a,null,V&&o.a.createElement(f,{show:!0,doLogout:ge,setPage:re,meQuery:xe,currentRoundId:l}),$&&o.a.createElement("div",null,"errorMessage"),!V&&o.a.createElement(E,{doLogin:function(e,n){var t,a,r;return i.a.async((function(o){for(;;)switch(o.prev=o.next){case 0:return o.next=2,i.a.awrap(he({variables:{username:e,password:n}}));case 2:t=o.sent,a=t.data.login.token,r=t.data.login.username,console.log("login token and username",a,r),a&&(W(a),ee(e),localStorage.setItem("username",r),localStorage.setItem("token",a),re("main"),oe.resetStore());case 7:case"end":return o.stop()}}))},show:!0,handleError:pe}),V&&!l&&o.a.createElement(p,{allLocationsQuery:Ie,allUsersQuery:we,handleLocationClick:function(e){return function(){console.log("location clicked",e),Q(e===N?null:e)}},handleUserClick:function(e){return function(){console.log("user clicked",e),j.includes(e)?O(j.filter((function(n){return n!==e}))):O(j.concat(e))}},currentLocation:N,currentPlayers:j,startNewRound:function(){var e;return i.a.async((function(n){for(;;)switch(n.prev=n.next){case 0:return console.log("start new round",N.id,j.map((function(e){return e.id}))),n.next=3,i.a.awrap(Ee({variables:{userIds:j.map((function(e){return e.id})),locationId:N.id}}));case 3:e=n.sent,console.log("response",e),y(e.data.addRound),u(e.data.addRound.id);case 7:case"end":return n.stop()}}))},show:"round"===ae}),V&&o.a.createElement(v,{allLocationsQuery:Oe,setRound:function(e){console.log("round",e),y(e),u(e.id),H(-1)},deleteRound:function(e){var n;return i.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:return console.log("delte round with id",e.id),t.next=3,i.a.awrap(be({variables:{roundId:e.id}}));case 3:n=t.sent,console.log("response",n);case 5:case"end":return t.stop()}}))},show:"main"===ae}),V&&l&&o.a.createElement(g,{allPointsQuery:je,round:k,addNewTrack:function(){var e=oe.readQuery({query:U,variables:{roundId:l}}).allPoints;console.log("all points",e);var n=-1;e.forEach((function(e){e.trackIndex>n&&(n=e.trackIndex)})),k.users.forEach((function(e){ke(l,e.id,n+1,3)}))},updatePoint:function(e,n){return i.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:console.log("add point with points and userId",e,"trackIndex",A,n,l),ke(l,n,A,e);case 2:case"end":return t.stop()}}))},deleteLastTrack:function(){return i.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("delete last track"),ye(l);case 2:case"end":return e.stop()}}))},changeTrack:function(e){H(e)},trackIndex:A,finishRound:function(){console.log("finish round"),y(null),u(null),O([]),Q(null),re("main")},uploadPoints:function(){var e,n,t;return i.a.async((function(a){for(;;)switch(a.prev=a.next){case 0:if(0!==(e=oe.readQuery({query:U,variables:{roundId:l}})).allPoints.length){a.next=3;break}return a.abrupt("return");case 3:return n=e.allPoints,console.log("upload points from cache to server",n),a.prev=5,a.next=8,i.a.awrap(fe(!0));case 8:return a.next=10,i.a.awrap(ve({variables:{roundId:l,pointIds:n.map((function(e){return e.id.toString()})),userIds:n.map((function(e){return e.user.id.toString()})),trackIndexes:n.map((function(e){return e.trackIndex})),points:n.map((function(e){return e.points}))}}));case 10:t=a.sent,fe(!1),console.log("response",t),console.log("server and local state match",ce),a.next=19;break;case 16:a.prev=16,a.t0=a.catch(5),pe(a.t0);case 19:case"end":return a.stop()}}),null,null,[[5,16]])},show:"round"===ae,savedState:ce,uploadingPoints:me}),o.a.createElement("div",null,o.a.createElement("br",null),o.a.createElement("em",null,"Frisbeegolf app, Fullstack course 2019 assignment, Juho Taipale")))},A=t(12),H=t(368),G=t(161),K=t(160),V=t(157),W=t(15),X=t(156),Z=t(3),ee=window.location.origin.replace(/^http/,"ws"),ne="".concat(ee,"/graphql");console.log("websocket uri",ne),console.log("http uri","/graphql");var te=new X.a({uri:ne,options:{reconnect:!0}}),ae=Object(G.a)({uri:"/graphql"}),re=Object(V.a)((function(e,n){var t=n.headers,r=localStorage.getItem("token");return{headers:Object(a.a)({},t,{authorization:r?"bearer ".concat(r):null})}})),oe=Object(W.d)((function(e){var n=e.query,t=Object(Z.l)(n),a=t.kind,r=t.operation;return"OperationDefinition"===a&&"subscription"===r}),te,re.concat(ae)),le=new H.a({link:oe,cache:new K.a});u.a.render(o.a.createElement(A.a,{client:le},o.a.createElement(A.a,{client:le},o.a.createElement(z,null))),document.getElementById("root"))}},[[173,1,2]]]);
//# sourceMappingURL=main.8ce2a039.chunk.js.map
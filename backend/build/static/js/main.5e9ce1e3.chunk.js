(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{170:function(e,n,t){e.exports=t(367)},178:function(e,n){},180:function(e,n){},214:function(e,n){},215:function(e,n){},367:function(e,n,t){"use strict";t.r(n);var a=t(44),r=t(0),o=t.n(r),l=t(142),u=t.n(l),c=t(10),i=t.n(c),s=t(22),d=t(13),m=t(63),f=t(369),p=t(371),v=t(370),g=function(e){if(!e.show)return null;var n=function(n){e.setPage(n)},t=e.username,a=e.currentRoundId;return o.a.createElement("div",{className:"ui secondary menu"},o.a.createElement("div",{className:"item",onClick:function(){n("main"),console.log("main")}},"main"),a?o.a.createElement("div",{className:"item",onClick:function(){n("round"),console.log("continue round")}},"continue round"):o.a.createElement("div",{className:"item",onClick:function(){n("round"),console.log("new round")}},"new round"),o.a.createElement("div",{className:"item"},t," logged in"),o.a.createElement("div",{className:"item",onClick:function(){n(null),e.doLogout()}},"logout"))},b=function(e){if(!e.show)return null;if(!e.round)return console.log("no round chosen"),null;if(e.allPointsQuery.loading)return console.log("loading"),o.a.createElement("div",null,"loading...");if(e.allPointsQuery.error)return console.log("error",e.allPointsQuery.error),o.a.createElement("div",null,"error...");var n=e.savedState,t=e.uploadingPoints,a=n||t,r=e.round.users,l=e.trackIndex,u=e.allPointsQuery.data.allPoints,c=e.round,i=r.slice();console.log("all points",u);var s=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;return e.forEach(function(e){n<e&&(n=e)}),n}(u.map(function(e){return e.trackIndex}),-1);if(-1===l&&s>-1)return e.changeTrack(s),null;0===u.length&&(console.log("new round",e.round),e.addNewTrack(),e.changeTrack(0));var d=function(n){return function(){console.log("new index",n,"max index",s),s+1===n&&(console.log("add new track"),e.addNewTrack()),e.changeTrack(n)}},m=function(n,t){return function(){n>-1&&e.updatePoint(n,t.id)}};i.sort(function(e,n){for(var t=function(t){var a=u.filter(function(e){return e.trackIndex===t}),r=a.filter(function(n){return n.user.id===e.id}),o=a.filter(function(e){return e.user.id===n.id});if(0===r.length||0===o.length)return{v:0};var l=r[0].points,c=o[0].points;return l>c?{v:1}:l<c?{v:-1}:void 0},a=l;a>=0;a--){var r=t(a);if("object"===typeof r)return r.v}return 0});var f=[];console.log("max track index",s,"track index",l);for(var p=0;p<s+1;p++)f.push(o.a.createElement("th",{key:p},p+1));return console.log("track numbers th",f,"all points",u),o.a.createElement("div",{className:"App"},n&&o.a.createElement("div",null,"saved state"),!n&&o.a.createElement("div",null,o.a.createElement("strong",null,"unsaved state")),o.a.createElement("div",null,o.a.createElement("h3",null,c.location.name),o.a.createElement("h3",null,o.a.createElement("div",{className:"row"},o.a.createElement("button",{text:"-",onClick:d(l-1)},"-"),"Track ",l+1,o.a.createElement("button",{text:"+",onClick:d(l+1)},"+"))),o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,"order"),o.a.createElement("th",null,"player"),f,o.a.createElement("th",null,"total"))),o.a.createElement("tbody",null,r.map(function(e){var n=u.filter(function(n){return n.user.id===e.id});if(n){n.sort(function(e,n){return e.trackIndex-n.trackIndex});var t=0===n.length?0:n.map(function(e){return e.points}).reduce(function(e,n){return e+n});return o.a.createElement("tr",{key:e.id},o.a.createElement("td",{key:"order"},function(e){for(var n=0;n<i.length;n++)if(e===i[n])return n+1+".";return"err"}(e)),o.a.createElement("td",{key:e.username},e.username),n.map(function(n){return n.trackIndex===l?o.a.createElement("td",{key:n.trackIndex+e.id},o.a.createElement("strong",null,o.a.createElement("button",{className:"ui button",onClick:m(n.points-1,n.user)},"-"),n.points,o.a.createElement("button",{className:"ui button",onClick:m(n.points+1,n.user)},"+"))):o.a.createElement("td",{key:n.trackIndex+e.id},n.points)}),o.a.createElement("td",null,t))}return o.a.createElement("tr",null,o.a.createElement("td",null,"no plays"))})))),o.a.createElement("br",null),o.a.createElement("div",{className:"row"},o.a.createElement("button",{className:"ui button",text:"delete last track",onClick:function(){e.deleteLastTrack()}},"delete last track"),o.a.createElement("button",{className:"ui button",text:"finish round",onClick:function(){e.finishRound()}},"finnish round"),o.a.createElement("button",{className:"ui button",disabled:a,onClick:function(){e.uploadPoints()}},"upload points")),!1)},E=function(e){if(!e.show)return null;var n=e.allLocationsQuery.data.allLocations,t=e.allUsersQuery.data.allUsers,a=e.currentLocation,r=e.currentPlayers;return e.allLocationsQuery.loading||e.allUsersQuery.loading?(console.log("loading"),o.a.createElement("div",null,"loading...")):e.allLocationsQuery.error||e.allUsersQuery.error?(console.log("errors",e.allUsersQuery.error,e.allLocationsQuery.error),o.a.createElement("div",null,"error...")):a?o.a.createElement("div",null,o.a.createElement("h3",null,"New round"),o.a.createElement("div",{onClick:e.handleLocationClick(a)},a.name),o.a.createElement("div",null,o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",{key:"header"},o.a.createElement("th",null,"selected players"))),o.a.createElement("tbody",null,o.a.createElement("tr",null,r.map(function(n){return o.a.createElement("td",{className:"ui button",key:n.id,onClick:e.handleUserClick(n)},n.username)}))))),r.length>0&&a&&o.a.createElement("div",null,o.a.createElement("form",{onSubmit:function(n){console.log("start new round with",a,r),n.preventDefault(),e.startNewRound()}},o.a.createElement("button",{className:"ui button",type:"submit"},"start"))),o.a.createElement("div",null,o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",null,o.a.createElement("th",null,"all players"))),o.a.createElement("tbody",null,t.map(function(n){return o.a.createElement("tr",{key:n.id},o.a.createElement("td",{className:"ui button",onClick:e.handleUserClick(n)},n.username))}))))):o.a.createElement("div",null,o.a.createElement("h3",null,"Select location"),o.a.createElement("div",null,o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",{key:"header"},o.a.createElement("th",null,"locations"))),o.a.createElement("tbody",null,n.map(function(n){return o.a.createElement("tr",{key:n.id},o.a.createElement("td",{className:"ui button",onClick:e.handleLocationClick(n)},n.name))})))))},h=function(e){if(!e.show)return null;if(e.result.loading)return o.a.createElement("div",null,"loading...");if(e.result.error)return console.log("error",e.result.error),o.a.createElement("div",null,"error...");var n=function(n){return function(){console.log("round clicked",n),e.setRound(n)}},t=function(n){return function(){console.log("delete round clicked",n),e.deleteRound(n)}},a=e.result.data.allRounds;return a.sort(function(e,n){return n.date-e.date}),a?o.a.createElement("div",null,o.a.createElement("table",{className:"ui celled table"},o.a.createElement("thead",null,o.a.createElement("tr",{key:"header"},o.a.createElement("th",null,"location"),o.a.createElement("th",null,"date"),o.a.createElement("th",{colSpan:"99"},"players"))),o.a.createElement("tbody",null,a.map(function(e){var a=new Date(e.date),r=a.getDate()+"."+(a.getMonth()+1)+"."+a.getFullYear()+" "+a.getHours()+":"+a.getMinutes()+":"+a.getSeconds();return o.a.createElement("tr",{key:e.id},o.a.createElement("td",{onClick:n(e)},e.location.name),o.a.createElement("td",null,r),e.users.map(function(e){return o.a.createElement("td",{key:e.username},e.username)}),o.a.createElement("td",null,o.a.createElement("button",{onClick:t(e)},"delete")))})))):null},k=function(e){var n=Object(r.useState)(""),t=Object(d.a)(n,2),a=t[0],l=t[1],u=Object(r.useState)(""),c=Object(d.a)(u,2),m=c[0],f=c[1];if(!e.show)return null;var p=function(){var n=Object(s.a)(i.a.mark(function n(t){return i.a.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:t.preventDefault(),e.doLogin(a,m);case 2:case"end":return n.stop()}},n)}));return function(e){return n.apply(this,arguments)}}();return o.a.createElement("div",{className:"login"},o.a.createElement("h2",null,"Login to application"),o.a.createElement("form",{onSubmit:p,className:"ui form"},o.a.createElement("div",{className:"field"},o.a.createElement("label",null,"Username"),o.a.createElement("input",{id:"username",type:"text",placeholder:"username",value:a,onChange:function(e){l(e.target.value)}})),o.a.createElement("div",{className:"field"},o.a.createElement("label",null,"Password"),o.a.createElement("input",{id:"password",type:"password",placeholder:"password",value:m,onChange:function(e){f(e.target.value)}})),o.a.createElement("button",{className:"ui button",type:"submit"},"login")))},y=t(143),I=t.n(y),w=t(17),j=t(18),O=t.n(j);function x(){var e=Object(w.a)(["\n  mutation addCachedPoints($roundId: ID!, $pointIds: [ID!]!, $userIds: [ID!]!, $trackIndexes:[Int!]!, $points: [Int!]!){\n    addCachedPoints(\n      roundId: $roundId,\n      pointIds: $pointIds,\n      userIds: $userIds,\n      trackIndexes: $trackIndexes,\n      points: $points\n    ){\n      trackIndex,\n      user{id},\n      round{id},\n      points,\n      id\n    }\n  }\n"]);return x=function(){return e},e}function P(){var e=Object(w.a)(["\n  mutation createPlay($roundId: ID!, $playNumber:Int!){\n    addPlay(\n      roundId: $roundId,\n      playNumber: $playNumber\n    ){\n      id\n    }\n  }\n"]);return P=function(){return e},e}function N(){var e=Object(w.a)(["\n  mutation removeRound($roundId: ID!){\n    deleteRound(\n      roundId: $roundId\n    ){\n      id\n    }\n  }\n"]);return N=function(){return e},e}function S(){var e=Object(w.a)(["\n  mutation createRound($locationId: ID!, $userIds: [ID!]!){\n    addRound(\n      locationId: $locationId\n      userIds: $userIds\n    ){\n      location{\n        name\n        id\n      }\n      users{\n        username\n        id\n      }\n      date\n      id\n    }\n  }\n"]);return S=function(){return e},e}function Q(){var e=Object(w.a)(["\n  mutation createLocation($name: String!){\n    addLocation(\n      name: $name\n    ){\n      id, name\n    }\n  }\n"]);return Q=function(){return e},e}function C(){var e=Object(w.a)(["\n{\n  me{\n    username\n    id\n  }\n}\n"]);return C=function(){return e},e}function $(){var e=Object(w.a)(["\nquery {\n  allUsers{\n    username,\n    id\n  }\n}\n"]);return $=function(){return e},e}function R(){var e=Object(w.a)(["\n  query ($roundId: ID!) {\n    allPoints(\n      roundId: $roundId\n    ){\n    trackIndex,\n    user{id},\n    round{id},\n    points,\n    id\n    }\n  }\n"]);return R=function(){return e},e}function L(){var e=Object(w.a)(["\n{\n  allRounds {\n    users{username, id}\n    location{name, id}\n    date\n    id\n  }\n}\n"]);return L=function(){return e},e}function q(){var e=Object(w.a)(["\n{\n  allLocations {\n    name\n    id\n  }\n}  \n"]);return q=function(){return e},e}function T(){var e=Object(w.a)(["\n{\n  me {\n    username\n    id\n    friends{username, id}\n  }\n}\n"]);return T=function(){return e},e}function D(){var e=Object(w.a)(["\nmutation login($username: String!, $password: String! ){\n  login(username: $username, password: $password){\n    token\n    username\n  }\n  \n}\n"]);return D=function(){return e},e}var U=O()(D()),_=(O()(T()),O()(q())),J=O()(L()),M=O()(R()),B=O()($()),F=(O()(C()),O()(Q()),O()(S())),Y=O()(N()),z=(O()(P()),O()(x()));var A=function(e){var n,t=function(){console.log("You have been loged out"),e()},a=function(){n=setTimeout(t,36e5)};Object(r.useEffect)(function(){var e=["load","mousedown","click","scroll","keypress"],t=function(){n&&clearTimeout(n),a()};for(var r in e)window.addEventListener(e[r],t);a()},[])},H=function(e){var n=Object(r.useState)(null),t=Object(d.a)(n,2),l=t[0],u=t[1],c=Object(r.useState)(null),y=Object(d.a)(c,2),w=y[0],j=y[1],O=Object(r.useState)([]),x=Object(d.a)(O,2),P=x[0],N=x[1],S=Object(r.useState)(null),Q=Object(d.a)(S,2),C=Q[0],$=Q[1],R=Object(r.useState)(null),L=Object(d.a)(R,2),q=L[0],T=L[1],D=Object(r.useState)(0),H=Object(d.a)(D,2),G=H[0],K=H[1],V=Object(r.useState)(null),W=Object(d.a)(V,2),X=W[0],Z=W[1],ee=Object(r.useState)(null),ne=Object(d.a)(ee,2),te=ne[0],ae=ne[1],re=Object(r.useState)("main"),oe=Object(d.a)(re,2),le=oe[0],ue=oe[1],ce=Object(m.b)(),ie=Object(r.useState)(!0),se=Object(d.a)(ie,2),de=se[0],me=se[1],fe=Object(r.useState)(!1),pe=Object(d.a)(fe,2),ve=pe[0],ge=pe[1];Object(r.useEffect)(function(){var e=localStorage.getItem("username"),n=localStorage.getItem("token");console.log("restore logged user",e,n),Z(n),ae(e)},[]);var be=function(){var e=Object(s.a)(i.a.mark(function e(n,t){var a,r,o;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,we({variables:{username:n,password:t}});case 2:a=e.sent,r=a.data.login.token,o=a.data.login.username,console.log("login token and username",r,o),r&&(Z(r),ae(n),localStorage.setItem("username",o),localStorage.setItem("token",r),ue("main"),ce.resetStore());case 7:case"end":return e.stop()}},e)}));return function(n,t){return e.apply(this,arguments)}}(),Ee=function(){console.log("logout"),Z(null),ae(null),localStorage.clear(),ce.resetStore()};A(Ee),e.sessionTimeout&&(console.log("session time out received"),Ee());var he=function(e){if(console.log("error",e),e.graphQLErrors.length>0)T(e.graphQLErrors[0].message),setTimeout(function(){T(null)},1e4);else if(e.networkError){var n=e.networkError.result.errors;n&&n.length>0&&(T(n[0].message),setTimeout(function(){T(null)},1e4))}},ke=Object(f.a)(z,{onError:he,update:function(e,n){var t=n.data.addCachedPoints,a=e.readQuery({query:M,variables:{roundId:l}}).allPoints;me(!0),console.log("local and server lengths",a.length,t.length),t.length!==a.length?me(!1):t.forEach(function(e){var n=!1;a.forEach(function(t){if(e.round.id===t.round.id&&e.user.id===t.user.id&&e.trackIndex===t.trackIndex&&e.points===t.points)return n=!0,void console.log("found match")}),n||(console.log("set saved state to false"),me(!1))}),console.log("local and server points",a,t)}}),ye=Object(f.a)(F,{onError:he,update:function(e,n){var t=e.readQuery({query:J}),a=n.data.addRound,r=t.allRounds.filter(function(e){return e.id!==a.id}).concat(a);ce.writeQuery({query:J,data:{allRounds:r}})}}),Ie=Object(f.a)(Y,{onError:he,update:function(e,n){var t=e.readQuery({query:J}),a=n.data.deleteRound;console.log("deleted round",a,"rounds before",t.allRounds);var r=t.allRounds.filter(function(e){return e.id!==a.id});console.log("new data in store",r),ce.writeQuery({query:J,data:{allRounds:r}})}}),we=Object(f.a)(U,{onError:he}),je=function(e,n,t,r){console.log("add point with roundId userId, trackindex, points",e,n,t,r);var o=ce.readQuery({query:M,variables:{roundId:e}});console.log("original state",o.allPoints);var l=o.allPoints.filter(function(e){return e.user.id===n&&e.trackIndex===t});if(console.log("found data from cache",l.length>0&&l),l.length>0){var u=l[0];console.log("new state",o.allPoints.filter(function(e){return e.id!==u.id}).concat(Object(a.a)({},u,{points:r}))),ce.writeQuery({query:M,variables:{roundId:e},data:{allPoints:o.allPoints.filter(function(e){return e.id!==u.id}).concat(Object(a.a)({},u,{points:r}))}})}else{var c={round:{id:e,__typename:"Round"},user:{id:n,__typename:"User"},trackIndex:t,points:r,id:I.a.randomBytes(16).toString("hex"),__typename:"Point"};console.log("add new point",c),ce.writeQuery({query:M,variables:{roundId:e},data:{allPoints:o.allPoints.concat(c)}})}me(!1)},Oe=function(e){var n=ce.readQuery({query:M,variables:{roundId:e}});if(0!==n.allPoints.length){console.log("original state",n.allPoints);var t=n.allPoints.map(function(e){return e.trackIndex}).sort(function(e,n){return n-e})[0];console.log("maxTrackindex",t),ce.writeQuery({query:M,variables:{roundId:e},data:{allPoints:n.allPoints.filter(function(e){return e.trackIndex!==t})}}),me(!1),G>=t&&K(t-1)}},xe=function(){var e=Object(s.a)(i.a.mark(function e(){var n,t,a;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==(n=ce.readQuery({query:M,variables:{roundId:l}})).allPoints.length){e.next=3;break}return e.abrupt("return");case 3:return t=n.allPoints,console.log("upload points from cache to server",t),e.prev=5,e.next=8,ge(!0);case 8:return e.next=10,ke({variables:{roundId:l,pointIds:t.map(function(e){return e.id.toString()}),userIds:t.map(function(e){return e.user.id.toString()}),trackIndexes:t.map(function(e){return e.trackIndex}),points:t.map(function(e){return e.points})}});case 10:a=e.sent,ge(!1),console.log("response",a),console.log("server and local state match",de),e.next=19;break;case 16:e.prev=16,e.t0=e.catch(5),he(e.t0);case 19:case"end":return e.stop()}},e,null,[[5,16]])}));return function(){return e.apply(this,arguments)}}(),Pe=function(){var e=Object(s.a)(i.a.mark(function e(){return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("delete last track"),Oe(l);case 2:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}(),Ne=function(){var e=Object(s.a)(i.a.mark(function e(n,t){return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:console.log("add point with points and userId",n,"trackIndex",G,t,l),je(l,t,G,n);case 2:case"end":return e.stop()}},e)}));return function(n,t){return e.apply(this,arguments)}}(),Se=Object(p.a)(_),Qe=Object(p.a)(B,{skip:!1}),Ce=Object(p.a)(M,{skip:!l,variables:{roundId:l}}),$e=Object(p.a)(J,{skip:!1}),Re=function(){var e=Object(s.a)(i.a.mark(function e(n){var t;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("delte round with id",n.id),e.next=3,Ie({variables:{roundId:n.id}});case 3:t=e.sent,console.log("response",t);case 5:case"end":return e.stop()}},e)}));return function(n){return e.apply(this,arguments)}}(),Le=function(){var e=Object(s.a)(i.a.mark(function e(){var n;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("start new round",C.id,P.map(function(e){return e.id})),e.next=3,ye({variables:{userIds:P.map(function(e){return e.id}),locationId:C.id}});case 3:n=e.sent,console.log("response",n),j(n.data.addRound),u(n.data.addRound.id);case 7:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}();return o.a.createElement(v.a,null,X&&o.a.createElement(g,{show:!0,doLogout:Ee,setPage:ue,username:te,currentRoundId:l}),q&&o.a.createElement("div",null,"errorMessage"),!X&&o.a.createElement(k,{doLogin:be,show:!0,handleError:he}),X&&!l&&o.a.createElement(E,{allLocationsQuery:Se,allUsersQuery:Qe,handleLocationClick:function(e){return function(){console.log("location clicked",e),$(e===C?null:e)}},handleUserClick:function(e){return function(){console.log("user clicked",e),P.includes(e)?N(P.filter(function(n){return n!==e})):N(P.concat(e))}},currentLocation:C,currentPlayers:P,startNewRound:Le,show:"round"===le}),X&&o.a.createElement(h,{result:$e,setRound:function(e){console.log("round",e),j(e),u(e.id),K(-1)},deleteRound:Re,show:"main"===le}),X&&l&&o.a.createElement(b,{allPointsQuery:Ce,round:w,addNewTrack:function(){var e=ce.readQuery({query:M,variables:{roundId:l}}).allPoints;console.log("all points",e);var n=-1;e.forEach(function(e){e.trackIndex>n&&(n=e.trackIndex)}),w.users.forEach(function(e){je(l,e.id,n+1,3)})},updatePoint:Ne,deleteLastTrack:Pe,changeTrack:function(e){K(e)},trackIndex:G,finishRound:function(){console.log("finish round"),j(null),u(null),N([]),$(null),ue("main")},uploadPoints:xe,show:"round"===le,savedState:de,uploadingPoints:ve}),o.a.createElement("div",null,o.a.createElement("br",null),o.a.createElement("em",null,"Frisbeegolf app, Juho Taipale 2019")))},G=t(154),K=t(27),V=t(156),W=t(155),X=t(153),Z=t(12),ee=t(152),ne=t(2),te=window.location.origin.replace(/^http/,"ws"),ae="".concat(te,"/graphql");console.log("websocket uri",ae),console.log("http uri","/graphql");var re=new ee.a({uri:ae,options:{reconnect:!0}}),oe=Object(V.a)({uri:"/graphql"}),le=Object(X.a)(function(e,n){var t=n.headers,r=localStorage.getItem("token");return{headers:Object(a.a)({},t,{authorization:r?"bearer ".concat(r):null})}}),ue=Object(Z.d)(function(e){var n=e.query,t=Object(ne.l)(n),a=t.kind,r=t.operation;return"OperationDefinition"===a&&"subscription"===r},re,le.concat(oe)),ce=new K.a({link:ue,cache:new W.a});u.a.render(o.a.createElement(G.a,{client:ce},o.a.createElement(m.a,{client:ce},o.a.createElement(H,null))),document.getElementById("root"))}},[[170,1,2]]]);
//# sourceMappingURL=main.5e9ce1e3.chunk.js.map